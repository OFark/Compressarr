@inject IApplicationService ApplicationService
@inject IPresetManager PresetManager
@inject IDialogService DialogService
@inject ILayoutService LayoutService
@inject IJobManager JobManager

<MudExpansionPanel Class="job">
    <TitleContent>
        <MudText>@(NewPreset ? "New Preset" : preset.ToString())</MudText>
    </TitleContent>
    <ChildContent>
        <MudTextField @bind-Value="preset.Name" Label="Name" Class="mb-2" />
        <MudSelect @bind-Value="preset.Container" Label="Container" OffsetY="true" T="string" Strict="true" Class="mb-2">
            <MudSelectItem Value="@("copy")">copy - No change</MudSelectItem>
            <MudDivider />
            @foreach (var c in PresetManager.Containers)
            {
                <MudSelectItem Value="@c.Name">@c</MudSelectItem>
            }
        </MudSelect>
        <MudGrid>
            <MudItem md="6">
                <MudCard Class="my-2">
                    <MudCardContent>
                        <MudSelect @bind-Value="preset.VideoEncoder" Label="Video Encoder" OffsetY="true" T="Encoder" Immediate="true" Class="mb-2">
                            <MudSelectItem T="Encoder" Value="@(new ())" />
                            <MudDivider />
                            @foreach (var c in PresetManager.VideoEncoders.Where(x => x.Options != null))
                            {
                                <MudSelectItem Value="@c"><MudIcon Icon="@Icons.Outlined.Article" Style="vertical-align: middle;" /> @c.ToString()</MudSelectItem>
                            }

                            @if (PresetManager.VideoEncoders.Any(x => x.Options != null))
                            {
                                <MudDivider />
                            }

                            @foreach (var c in PresetManager.VideoEncoders.Where(x => x.Options == null))
                            {
                                <MudSelectItem Value="@c" />
                            }
                        </MudSelect>
                        <MudSelect @bind-Value="preset.HardwareDecoder" Clearable="true" Label="Hardware Decoder" OffsetY="true" T="string" Immediate="true" Class="mb-2">
                            @foreach (var hwd in ApplicationService.HardwareDecoders)
                            {
                                <MudSelectItem Value="@hwd" />
                            }
                        </MudSelect>
                        <MudTextField @bind-Value="preset.VideoBitRate" Label="Video Bitrate" Disabled="@disabledNoVideo" Class="mb-2" />
                        <MudNumericField @bind-Value="preset.FrameRate" Label="Framerate" Placeholder="Same as source" Disabled="@disabledNoVideo" Class="mb-2" />
                    </MudCardContent>
                </MudCard>
                @if (preset.VideoEncoder != null && !preset.VideoEncoder.IsCopy && preset.VideoCodecOptions != null)
                {
                    <MudCard Class="my-2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Additional codec based options</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @foreach (var option in preset.VideoCodecOptions)
                            {
                                switch (option.EncoderOption.Type)
                                {
                                    case Presets.CodecOptionType.Number:
                                        {
                                            <MudNumericField @bind-Value="option.Value" Label="@option.Name" />
                                        }
                                        break;
                                    case Presets.CodecOptionType.Range:
                                        {
                                            <MudSlider @bind-Value="@option.IntValue" T="int?" Max="@option.EncoderOption.Max" Min="option.EncoderOption.Min" Immediate="true" Disabled="@(option.EncoderOption.DisabledByVideoBitRate && disabledVideoBitrate)">@option.Name: @option.Value <MudIconButton Size="Size.Small" Icon="@Icons.Outlined.Delete" OnClick="@(() => { option.IntValue = null; })"></MudIconButton></MudSlider>
                                        }
                                        break;
                                    case Presets.CodecOptionType.Select:
                                        {
                                            <MudSelect @bind-Value="option.Value" Label="@option.Name" Clearable="true" OffsetY="true">
                                                @foreach (var c in option.EncoderOption.Values)
                                                                    {
                                                    <MudSelectItem Value="@c">@c</MudSelectItem>
                                                                    }
                                            </MudSelect>
                                        }
                                        break;
                                    case Presets.CodecOptionType.String:
                                        {
                                            <MudTextField @bind-Value="option.Value" Label="@option.Name" />
                                        }
                                        break;
                                }
                            }
                        </MudCardContent>
                    </MudCard>
                }
            </MudItem>
            <MudItem md="6">
                @foreach (var fasp in preset.AudioStreamPresets)
                {
                    <AudioPreset AudioStreamPreset="@fasp" OnUpdate="AudioPresetUpdate" OnCopy="CopyAudioStreamPreset" />
                }
            </MudItem>



        </MudGrid>

        <MudTextField @bind-Value="preset.OptionalArguments" Label="Additional arguments" Class="mb-2" />

        <MudCardActions>
            <MudButton OnClick="savePreset" Color="Color.Primary" StartIcon="@Icons.Outlined.Save" Class="mr-3">Save</MudButton>
            @if (!NewPreset)
            {
                <MudButton OnClick="deletePreset" Color="Color.Error" StartIcon="@Icons.Outlined.Delete" Disabled="@JobManager.PresetInUse(preset)">Delete</MudButton>
            }
        </MudCardActions>
    </ChildContent>
</MudExpansionPanel>

@code {
    [Parameter]
    public FFmpegPreset preset { get; set; }

    [Parameter]
    public bool NewPreset { get; set; }

    [Parameter]
    public EventCallback OnAdd { get; set; }

    private bool disabledNoVideo => preset.VideoEncoder?.IsCopy ?? true;
    private bool disabledVideoBitrate => preset.VideoBitRate.HasValue;

    protected override void OnInitialized()
    {
        LayoutService.OnStateChanged += (o, e) => InvokeAsync(StateHasChanged);
        base.OnInitialized();
    }

    private void AudioPresetUpdate()
    {
        var firstCoverAny = preset.AudioStreamPresets.FirstOrDefault(f => f.CoversAny);

        if (firstCoverAny == null)
        {
            preset.AudioStreamPresets.Add(new());
        }
        else
        {
            if (firstCoverAny != preset.AudioStreamPresets.Last())
            {
                var indexofRemoval = preset.AudioStreamPresets.IndexOf(firstCoverAny) + 1;
                preset.AudioStreamPresets.RemoveRange(indexofRemoval, preset.AudioStreamPresets.Count() - indexofRemoval);
            }
        }
        InvokeAsync(StateHasChanged);
    }

    private void CopyAudioStreamPreset(FFmpegAudioStreamPreset asPreset)
    {
        var index = preset.AudioStreamPresets.IndexOf(asPreset);

        if (index >= 0)
        {
            var clone = asPreset.Clone();
            preset.AudioStreamPresets.Insert(index, clone);
            InvokeAsync(StateHasChanged);
        }
    }

    private async void savePreset()
    {
        using (LayoutService.Working("Saving..."))
        {

            await PresetManager.AddPresetAsync(preset);

            JobManager.InitialiseJobs(preset);

            if (OnAdd.HasDelegate)
            {
                await OnAdd.InvokeAsync();
            }

            LayoutService.RaiseChange();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void deletePreset()
    {
        using (LayoutService.Working("Deleting..."))
        {

            bool? result = await DialogService.ShowMessageBox(
            "Warning",
            "Deleting can not be undone!",
            yesText: "Delete!", cancelText: "Cancel");

            if (result ?? false)
            {
                await PresetManager.DeletePresetAsync(preset);
                LayoutService.RaiseChange();
            }
            await InvokeAsync(StateHasChanged);
        }
    }
}
