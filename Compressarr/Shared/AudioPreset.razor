@inject IPresetManager PresetManager
@inject ILayoutService LayoutService

<MudCard Class="my-2">
    <MudCardContent>
        @foreach (var fil in AudioStreamPreset.Filters)
        {
            <AudioPresetFilter AudioStreamPresetFilter="fil" Filters="AudioStreamPreset.Filters" IsFirst="@(AudioStreamPreset.Filters.IndexOf(fil) == 0)" OnUpdate="Update" OnDelete="@(() => DeleteFilter(fil))" />

        }
        @if (AudioStreamPreset.Filters.Any() && AudioStreamPreset.Filters.Last().Rule != AudioStreamRule.Any)
        {
            <MudIconButton Icon="@Icons.Outlined.Add" OnClick="@(() => AudioStreamPreset.Filters.Add(new()) )" />
        }
        <MudGrid>
            <MudItem sm="1">
                <MudText Style="padding-top: 1.65em">
                    Then
                </MudText>
            </MudItem>
            <MudItem sm="3">
                <MudSelect T="AudioStreamAction" @bind-Value="AudioStreamPreset.Action">
                    @foreach (AudioStreamAction r in Enum.GetValues(typeof(AudioStreamAction)))
                    {
                        <MudSelectItem Value="r">@r.ToString().ToCamelCaseSplit()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            @switch (AudioStreamPreset.Action)
            {
                case AudioStreamAction.Encode:
                    {

                        <MudItem sm="3">
                            <MudSelect T="Encoder" @bind-Value="AudioStreamPreset.Encoder" Label="Encoder">
                                @foreach (var ae in PresetManager.AudioEncoders)
                                {
                                    <MudSelectItem Value="ae" />
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem sm="4">
                            <MudSelect T="string" OffsetY="true" Clearable="true" @bind-Value="AudioStreamPreset.BitRate" Label="Bit Rate">
                                @foreach (var b in PresetManager.AudioBitrates)
                                {
                                    <MudSelectItem Value="b" />
                                }
                            </MudSelect>
                        </MudItem>
                    }
                    break;
                default:
                    {
                        <MudItem sm="7"></MudItem>
                    }
                    break;
            }
            <MudItem sm="1">
                @if (!AudioStreamPreset.CoversAny)
                {
                    <MudIconButton Icon="@Icons.Outlined.ContentCopy" OnClick="copy" />
                }
            </MudItem>
        </MudGrid>

    </MudCardContent>
</MudCard>
@code {

    [Parameter]
    public FFmpegAudioStreamPreset AudioStreamPreset { get; set; }

    [Parameter]
    public EventCallback OnUpdate { get; set; }

    [Parameter]
    public EventCallback<FFmpegAudioStreamPreset> OnCopy { get; set; }

    protected override void OnInitialized()
    {
        LayoutService.OnStateChanged += (o, e) => StateHasChanged();
        base.OnInitialized();
    }

    private void DeleteFilter(FFmpegAudioStreamPresetFilter filter)
    {
        AudioStreamPreset.Filters.Remove(filter);
        StateHasChanged();
    }

    private void copy()
    {
        OnCopy.InvokeAsync(AudioStreamPreset);
    }


    private void Update()
    {
        if (AudioStreamPreset.CoversAny)
        {
            AudioStreamPreset.Filters.RemoveAll(x => x.Rule != AudioStreamRule.Any);
        }

        OnUpdate.InvokeAsync();
    }
}
